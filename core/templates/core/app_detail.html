{% extends 'core/base.html' %}
{% block title %}{{ app.name }} ‚Äî AppForge{% endblock %}
{% block content %}
<div class="container" style="max-width: 720px; padding-top: 2rem;">
    <a href="{% url 'core:dashboard' %}" style="color: var(--muted); font-size: 0.9rem; text-decoration: none; margin-bottom: 1rem; display: inline-block;">‚Üê Dashboard</a>

    <form method="post" action="" style="margin-bottom: 2rem;">
        {% csrf_token %}
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
            <h1 style="font-size: 1.5rem;">Edit app</h1>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span style="font-size: 0.85rem; padding: 0.25rem 0.6rem; border-radius: 6px; background: var(--border); color: var(--muted); text-transform: capitalize;">{{ app.status }}</span>
                {% if app.published %}
                <span style="font-size: 0.85rem; padding: 0.25rem 0.6rem; border-radius: 6px; background: rgba(52,211,153,0.2); color: var(--success);">Published</span>
                {% endif %}
            </div>
        </div>
        <div class="form-group">
            <label for="id_name">App name</label>
            {{ form.name }}
            {{ form.name.errors }}
        </div>
        <div class="form-group">
            <label for="id_slug">URL slug</label>
            {{ form.slug }}
            <p style="color: var(--muted); font-size: 0.85rem; margin-top: 0.35rem;">Public URL: /a/{{ form.slug.value|default:app.slug }}/</p>
            {{ form.slug.errors }}
        </div>
        <div class="form-group">
            <label for="id_description">Description</label>
            {{ form.description }}
            {{ form.description.errors }}
        </div>
        <div class="form-group" style="display: flex; align-items: center; gap: 0.5rem;">
            {{ form.published }}
            <label for="id_published" style="margin-bottom: 0;">Published (public can view at /a/{{ app.slug }}/)</label>
        </div>
        <button type="submit" class="btn btn-primary">Save changes</button>
    </form>

    <div class="chat-card" style="background: linear-gradient(135deg, rgba(167,139,250,0.12) 0%, rgba(139,92,246,0.06) 100%); border: 1px solid var(--accent); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem;">
        <h3 style="font-size: 1rem; margin-bottom: 0.35rem;">üí¨ Chat ‚Äî explain ideas, get changes & creations</h3>
        <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">Describe what you want: new sections, copy changes, or full page ideas. The AI will update this app.</p>
        <div id="chat-messages" style="min-height: 80px; max-height: 280px; overflow-y: auto; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem; font-size: 0.9rem;">
            <div id="chat-placeholder" style="color: var(--muted); text-align: center; padding: 0.5rem;">Send a message to start. e.g. "Add a testimonials section" or "Make the hero more punchy"</div>
        </div>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <input type="text" id="ai-prompt" class="input" placeholder="Describe changes or your idea‚Ä¶" style="flex: 1; min-width: 200px;">
            <button type="button" id="apply-prompt" class="btn btn-primary">Send</button>
        </div>
        <p style="color: var(--muted); font-size: 0.8rem; margin-top: 0.5rem;">Uses OPENAI_API_KEY. You can also edit JSON below.</p>
        <p style="color: #f87171; font-size: 0.85rem; margin-top: 0.5rem; display: none;" id="ai-error"></p>
    </div>

    <div style="background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem;">
        <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Preview & public link</h3>
        <p style="color: var(--muted); font-size: 0.95rem; margin-bottom: 1rem;">Share this link when published. You can always preview before publishing.</p>
        <a href="{% url 'core:app_public' app.slug %}" target="_blank" rel="noopener" class="btn btn-ghost">Open {{ app.published|yesno:"live page,preview" }} ‚Üí</a>
    </div>

    <div style="background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem;">
        <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Edit sections (hero, features, pricing)</h3>
        <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">Update the JSON below and click Save. Each section has type, title, subtitle, etc.</p>
        <textarea id="sections-json" class="input" rows="14" style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;">{{ sections_json }}</textarea>
        <p style="color: #f87171; font-size: 0.85rem; margin-top: 0.5rem; display: none;" id="sections-error">Invalid JSON. Fix and try again.</p>
        <button type="button" id="save-sections" class="btn btn-primary" style="margin-top: 0.75rem;">Save sections</button>
    </div>

    <div style="background: linear-gradient(135deg, rgba(167,139,250,0.1) 0%, rgba(139,92,246,0.05) 100%); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem;">
        <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">Deploy on KloudBean</h3>
        <p style="color: var(--muted); font-size: 0.95rem; margin-bottom: 1rem;">This product runs on KloudBean. Deploy once, rebrand, launch.</p>
        <a href="https://www.kloudbean.com/django-hosting/" target="_blank" rel="noopener" class="btn btn-primary">Learn more ‚Üí</a>
    </div>
</div>
<style>
.chat-msg { margin-bottom: 0.75rem; }
.chat-msg.user { text-align: right; }
.chat-msg.user span { display: inline-block; max-width: 85%; padding: 0.5rem 0.75rem; background: var(--accent); color: var(--bg); border-radius: 10px 10px 2px 10px; font-size: 0.9rem; }
.chat-msg.assistant span { display: inline-block; max-width: 90%; padding: 0.5rem 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 10px 10px 10px 2px; font-size: 0.9rem; color: var(--text); text-align: left; }
.chat-msg.typing { color: var(--muted); font-style: italic; }
</style>
<script>
(function() {
    var csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
    var applyBtn = document.getElementById('apply-prompt');
    var promptInput = document.getElementById('ai-prompt');
    var aiError = document.getElementById('ai-error');
    var chatMessages = document.getElementById('chat-messages');
    var chatPlaceholder = document.getElementById('chat-placeholder');
    function addMessage(role, text) {
        if (chatPlaceholder) chatPlaceholder.style.display = 'none';
        var div = document.createElement('div');
        div.className = 'chat-msg ' + role;
        var span = document.createElement('span');
        span.textContent = text;
        div.appendChild(span);
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    function removeTyping() {
        var t = document.getElementById('chat-typing');
        if (t) t.remove();
    }
    if (applyBtn && promptInput) {
        applyBtn.addEventListener('click', function() {
            var prompt = (promptInput.value || '').trim();
            if (!prompt) return;
            aiError.style.display = 'none';
            addMessage('user', prompt);
            promptInput.value = '';
            applyBtn.disabled = true;
            applyBtn.textContent = '‚Ä¶';
            var typing = document.createElement('div');
            typing.id = 'chat-typing';
            typing.className = 'chat-msg assistant typing';
            typing.innerHTML = '<span>Thinking‚Ä¶</span>';
            chatMessages.appendChild(typing);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            fetch('{% url "core:app_generate" app.pk %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
                body: JSON.stringify({ prompt: prompt })
            })
            .then(function(r) { return r.json(); })
            .then(function(res) {
                removeTyping();
                applyBtn.disabled = false;
                applyBtn.textContent = 'Send';
                if (res.ok && res.sections) {
                    addMessage('assistant', res.message || "I've applied your changes.");
                    document.getElementById('sections-json').value = JSON.stringify(res.sections, null, 2);
                } else {
                    addMessage('assistant', res.error || 'Something went wrong. Check OPENAI_API_KEY or try again.');
                }
                chatMessages.scrollTop = chatMessages.scrollHeight;
            })
            .catch(function() {
                removeTyping();
                applyBtn.disabled = false;
                applyBtn.textContent = 'Send';
                addMessage('assistant', 'Network error. Try again.');
                aiError.textContent = 'Network error';
                aiError.style.display = 'block';
            });
        });
        promptInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); applyBtn.click(); }
        });
    }
    var btn = document.getElementById('save-sections');
    var ta = document.getElementById('sections-json');
    var err = document.getElementById('sections-error');
    btn.addEventListener('click', function() {
        err.style.display = 'none';
        var data;
        try {
            data = JSON.parse(ta.value);
        } catch (e) {
            err.style.display = 'block';
            return;
        }
        if (!Array.isArray(data)) {
            err.style.display = 'block';
            return;
        }
        btn.disabled = true;
        btn.textContent = 'Saving‚Ä¶';
        fetch('{% url "core:app_sections_save" app.pk %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
            body: JSON.stringify(data)
        })
        .then(function(r) { return r.json(); })
        .then(function(res) {
            btn.disabled = false;
            btn.textContent = 'Save sections';
            if (res.ok) {
                btn.textContent = 'Saved ‚úì';
                setTimeout(function() { btn.textContent = 'Save sections'; }, 2000);
            } else {
                err.style.display = 'block';
            }
        })
        .catch(function() {
            btn.disabled = false;
            btn.textContent = 'Save sections';
            err.style.display = 'block';
        });
    });
})();
</script>
{% endblock %}
