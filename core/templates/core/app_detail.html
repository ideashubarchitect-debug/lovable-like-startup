{% extends 'core/base.html' %}
{% block title %}{{ app.name }} — AppForge{% endblock %}
{% block main_class %}main-full-bleed{% endblock %}
{% block content %}
<style>
.app-editor { display: flex; height: calc(100vh - 140px); min-height: 400px; }
.app-editor-left { width: 420px; flex-shrink: 0; display: flex; flex-direction: column; border-right: 1px solid var(--border); background: var(--surface); }
.app-editor-right { flex: 1; min-width: 0; display: flex; flex-direction: column; background: var(--bg); }
.app-editor-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; flex-wrap: wrap; }
.app-editor-chat { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }
.app-editor-prompt { padding: 1rem; border-top: 1px solid var(--border); }
.app-editor-prompt-inner { display: flex; gap: 0.5rem; }
.app-editor-prompt input { flex: 1; min-width: 0; }
.preview-frame { flex: 1; width: 100%; border: none; background: #fff; min-height: 300px; }
.chat-msg { max-width: 95%; }
.chat-msg.user { align-self: flex-end; }
.chat-msg.user span { display: inline-block; padding: 0.5rem 0.85rem; background: var(--accent); color: var(--bg); border-radius: 14px 14px 4px 14px; font-size: 0.9rem; }
.chat-msg.assistant { align-self: flex-start; }
.chat-msg.assistant span { display: inline-block; padding: 0.5rem 0.85rem; background: var(--border); border-radius: 14px 14px 14px 4px; font-size: 0.9rem; color: var(--text); }
.chat-msg.typing { align-self: flex-start; color: var(--muted); font-style: italic; font-size: 0.9rem; }
.app-editor-settings { padding: 1rem; border-top: 1px solid var(--border); font-size: 0.85rem; }
.app-editor-settings summary { cursor: pointer; color: var(--muted); }
.app-editor-settings-content { margin-top: 0.75rem; }
</style>

<div class="app-editor">
    <div class="app-editor-left">
        <div class="app-editor-header">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <a href="{% url 'core:dashboard' %}" style="color: var(--muted); text-decoration: none;">←</a>
                <span style="font-weight: 600;">{{ app.name }}</span>
                {% if app.published %}<span style="font-size: 0.75rem; color: var(--success);">Live</span>{% endif %}
            </div>
            <a href="{% url 'core:app_public' app.slug %}" target="_blank" rel="noopener" style="font-size: 0.85rem; color: var(--accent);">Open in new tab</a>
        </div>
        <div id="chat-messages" class="app-editor-chat">
            <div id="chat-placeholder" style="color: var(--muted); font-size: 0.9rem; text-align: center; padding: 1rem;">Describe what you want. e.g. "Build me a modern bakery website with dark mode and online menu" or "Add a testimonials section"</div>
        </div>
        <div class="app-editor-prompt">
            <div class="app-editor-prompt-inner">
                <input type="text" id="ai-prompt" class="input" placeholder="Describe changes or your idea…" autocomplete="off">
                <button type="button" id="apply-prompt" class="btn btn-primary">Send</button>
            </div>
            <p style="color: #f87171; font-size: 0.8rem; margin-top: 0.5rem; display: none;" id="ai-error"></p>
        </div>
        <details class="app-editor-settings">
            <summary>Settings &amp; advanced</summary>
            <div class="app-editor-settings-content">
                <form method="post" action="" style="margin-bottom: 1rem;">
                    {% csrf_token %}
                    <div class="form-group"><label>Name</label>{{ form.name }}</div>
                    <div class="form-group"><label>URL slug</label>{{ form.slug }}</div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 0.5rem;">{{ form.published }}<label style="margin:0;">Published</label></div>
                    <button type="submit" class="btn btn-ghost" style="font-size: 0.9rem;">Save</button>
                </form>
                <label style="font-size: 0.85rem;">Edit JSON</label>
                <textarea id="sections-json" class="input" rows="6" style="font-family: monospace; font-size: 0.8rem; margin-top: 0.35rem; width: 100%;">{{ sections_json }}</textarea>
                <button type="button" id="save-sections" class="btn btn-ghost" style="margin-top: 0.5rem; font-size: 0.85rem;">Save sections</button>
                <p style="color: #f87171; font-size: 0.8rem; margin-top: 0.35rem; display: none;" id="sections-error">Invalid JSON</p>
            </div>
        </details>
    </div>
    <div class="app-editor-right">
        <div class="app-editor-header" style="padding: 0.5rem 1rem;">
            <span style="font-size: 0.85rem; color: var(--muted);">Preview</span>
        </div>
        <iframe id="preview-iframe" class="preview-frame" src="{% url 'core:app_public' app.slug %}" title="Preview"></iframe>
    </div>
</div>

<script>
(function() {
    var csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
    var applyBtn = document.getElementById('apply-prompt');
    var promptInput = document.getElementById('ai-prompt');
    var aiError = document.getElementById('ai-error');
    var chatMessages = document.getElementById('chat-messages');
    var chatPlaceholder = document.getElementById('chat-placeholder');
    var previewIframe = document.getElementById('preview-iframe');

    function addMessage(role, text) {
        if (chatPlaceholder) chatPlaceholder.style.display = 'none';
        var div = document.createElement('div');
        div.className = 'chat-msg ' + role;
        var span = document.createElement('span');
        span.textContent = text;
        div.appendChild(span);
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    function removeTyping() {
        var t = document.getElementById('chat-typing');
        if (t) t.remove();
    }
    function refreshPreview() {
        if (previewIframe && previewIframe.src) {
            previewIframe.src = previewIframe.src.split('?')[0] + '?t=' + Date.now();
        }
    }

    if (applyBtn && promptInput) {
        applyBtn.addEventListener('click', function() {
            var prompt = (promptInput.value || '').trim();
            if (!prompt) return;
            aiError.style.display = 'none';
            addMessage('user', prompt);
            promptInput.value = '';
            applyBtn.disabled = true;
            applyBtn.textContent = '…';
            var typing = document.createElement('div');
            typing.id = 'chat-typing';
            typing.className = 'chat-msg assistant typing';
            typing.innerHTML = '<span>Building…</span>';
            chatMessages.appendChild(typing);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            fetch('{% url "core:app_generate" app.pk %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
                body: JSON.stringify({ prompt: prompt })
            })
            .then(function(r) { return r.json(); })
            .then(function(res) {
                removeTyping();
                applyBtn.disabled = false;
                applyBtn.textContent = 'Send';
                if (res.ok && res.sections) {
                    addMessage('assistant', res.message || "Done. Check the preview.");
                    var ta = document.getElementById('sections-json');
                    if (ta) ta.value = JSON.stringify(res.sections, null, 2);
                    refreshPreview();
                } else {
                    addMessage('assistant', res.error || 'Something went wrong.');
                }
                chatMessages.scrollTop = chatMessages.scrollHeight;
            })
            .catch(function() {
                removeTyping();
                applyBtn.disabled = false;
                applyBtn.textContent = 'Send';
                addMessage('assistant', 'Network error. Try again.');
                aiError.textContent = 'Network error';
                aiError.style.display = 'block';
            });
        });
        promptInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); applyBtn.click(); }
        });
    }

    var btn = document.getElementById('save-sections');
    var ta = document.getElementById('sections-json');
    var err = document.getElementById('sections-error');
    if (btn && ta) {
        btn.addEventListener('click', function() {
            err.style.display = 'none';
            var data;
            try { data = JSON.parse(ta.value); } catch (e) { err.style.display = 'block'; return; }
            if (!Array.isArray(data)) { err.style.display = 'block'; return; }
            btn.disabled = true;
            fetch('{% url "core:app_sections_save" app.pk %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
                body: JSON.stringify(data)
            })
            .then(function(r) { return r.json(); })
            .then(function(res) {
                btn.disabled = false;
                if (res.ok) { refreshPreview(); }
                else { err.style.display = 'block'; }
            })
            .catch(function() { btn.disabled = false; err.style.display = 'block'; });
        });
    }
})();
</script>
{% endblock %}
